pipeline {
    agent any
    triggers {
        githubPush()
    }
    environment {
        GITHUB_CREDENTIALS_ID = 'GH_CRED'
        GITHUB_REPO_OWNER = 'cyse7125-su24-team11'
        GITHUB_REPO_NAME = 'cve-llm'
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    changelog: false,
                    credentialsId: 'GH_CRED',
                    poll: false,
                    url: 'https://github.com/cyse7125-su24-team11/cve-llm.git'
            }
        }
        stage('PR') {
            steps {
                withCredentials([usernamePassword(credentialsId: GITHUB_CREDENTIALS_ID, usernameVariable: 'GITHUB_USERNAME', passwordVariable: 'GITHUB_TOKEN')]) {
                    script{
                        def prCommitSHA = sh(script: "git ls-remote https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}.git refs/pull/${env.CHANGE_ID}/head | cut -f1", returnStdout: true).trim()
                        echo "PR Commit SHA: ${prCommitSHA}"
                        env.PR_COMMIT_SHA = prCommitSHA
                    }
                }
            }
        }
        stage('Docker APP') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'DOCKER_CRED', usernameVariable: 'myuser', passwordVariable: 'docker_password')]) 
                {
                script {
                    try {
                        sh '''
                        docker login -u ${myuser} -p ${docker_password}
                        docker run --privileged --rm tonistiigi/binfmt --install all
                        
                        docker buildx build -f ./Dockerfile -t cve-llm:latest \
                            --build-arg db_user=${db_user} --build-arg db_password=${db_password} \
                             --build-arg db_name=${db_name} --build-arg db_host=${db_host} \
                              --build-arg db_port=${db_port} --build-arg huggingface_token=${huggingface_token} \
                            --platform "linux/arm64,linux/amd64" .
                        '''
                    } catch (Exception e) {
                        throw e
                    }
                }
                }
            }
            
        }
        stage('Semantic Release and Update Chart Version') {
            steps {
                withCredentials([usernamePassword(credentialsId: GITHUB_CREDENTIALS_ID, usernameVariable: 'GH_USERNAME', passwordVariable: 'GH_TOKEN')]) 
                {
                    withEnv(["GH_TOKEN=${GH_TOKEN}"]){
                        script {
                            def releaseOutput = sh(script: 'npx semantic-release --dry-run --json', returnStdout: true).trim()
                            echo "releaseOutput ${releaseOutput}"
                            def versionLine = releaseOutput.find(/Published release (\d+\.\d+\.\d+) on default channel/)
     
                            if (versionLine) {
                                // Extract the new version
                                def newVersion = (versionLine =~ /(\d+\.\d+\.\d+)/)[0][0]
                                echo "New version: v${newVersion}"
    
                                sh '''
                                docker tag cve-llm:latest maheshpoojaryneu/csye7125:cve-llm-'''+newVersion+'''
                                docker push maheshpoojaryneu/csye7125:cve-llm-'''+newVersion
                            } else {
                                error "Failed to capture the new version from semantic-release."
                            }
                        }
                    }
                }
            }
        }
    }
}
